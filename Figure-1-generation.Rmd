---
title: "Generate Figure 1"
output: html_notebook
---


## Setup

```{r}

# --- libraries
library(phytools)        # pylogenetic analysis
library(plyr)            # organise dataset
library(yarrr)           # transparent color
library(viridis)         # color palettes
library(predictFishRMR)

```

Load objects

```{r}
load("pars.rda")
load("kpars.rda")
load("rmr_data.rda")
load("tree.rda")
```


## Figure 1

Figure 1.  A persistently higher energetic cost to fuel mesothermy in fishes. Left panel shows the phylogeny used in the regression of mass, body temperature and thermal strategy (red for mesotherms and blue for ectotherms) on fish routine metabolic rate, shown in right panel. Data with black outline indicate RMR estimated by our new heat production method, with all other data derived from respirometry. 

```{r}
# Figure 1

# assign color for the two states

map_data <- ddply(rmr_data, c("spp", "therm"), summarise, logM = mean(logM))[,c(1,2)]
row.names(map_data) <- map_data$spp

#Vector with information of the caracter
a <-  tree$tip.label[order(tree$tip.label)]
b <-  map_data[map_data$spp %in% tree$tip.label, ]$therm

info_caracter <- setNames(c(b), a)
ancestor <- make.simmap(tree, info_caracter, model = "ER", nsim = 50)
ecomorph <- as.factor(getStates(ancestor, "tips"))

cols <- setNames(c("blue", "red"), levels(ecomorph))

# coef <- c(2.9468, 0.8271, 0.0805, 1.2333)
coef <- pars

# --- Figure 1. 
# A persistently higher energetic cost to fuel mesothermy in fishes. Left panel shows the phylogeny used in the regression of mass, 
# body temperature and thermal strategy (red for mesotherms and blue for ectotherms) on fish routine metabolic rate, shown in right panel. 
# Data with black outline indicate RMR estimated by our new heat production method, with all other data derived from respirometry. 

# Setup a pdf file in which to save the figure. 
# quartz("Fig 1", 9, 4.2, file = "Figure-1.pdf")
pdf(file = "Figure-1.pdf", 9, 4.2)
par(mfrow = c(1, 2))

plot(ancestor[[1]], colors = sapply(cols, make.transparent, alpha = 0.1), type = "fan", add = F, lwd = 4, ftype = "off", fsize = 0.6, offset = 0.5)
for(i in 1:length(ancestor))
  plot(ancestor[[i]], colors = sapply(cols, make.transparent, alpha = 0.1), type = "fan", add = T, lwd = 4, ftype = "off", fsize = 0.6, offset = 0.5)

par(mar = c(5.1, 5.1, 2.1, 2.1))
rmr_data$therm <- factor(rmr_data$therm)
pt.cols <- setNames(c("blue", "red"), levels(rmr_data$therm))

plot((logRMR - T * coef[3]) ~ logM, data = rmr_data, pch = c(21, 24)[as.numeric(rmr_data$method)], cex = c(0.9, 1.3)[as.numeric(rmr_data$method)], bg = pt.cols[rmr_data$therm], col = "white", lwd = 0.5, ylab = "", xlab = "", xaxt = "n", yaxt = "n")

mtext(side = 2, expression("Routine metabolic rate (g O"[2]*" h"^-1*" )"), line = 3.5)

axis(1, at = log(c(0.00001, 0.001, 0.1, 10, 1000)), labels = c("10 mg", "1 g", "100 g", "10 Kg", "1Ton"))
axis(2, las = 1, at = log(c(0.0001, 0.001, 0.01, 0.1, 1, 10, 100, 1000, 10000, 100000)), 
  labels = c(expression("10"^-7*""), expression("10"^-6*""), expression("10"^-5*""), expression("10"^-4*""), 
    expression("10"^-3*""), expression("10"^-2*""), expression("10"^-1*""), expression("1"), expression("10"), expression("10"^2*"")))    

legend("bottomright", c("Respirometry", "Heat production", "", "Mesotherms", "Ectotherms"), 
  pch = c(1, 2, NA, 21, 21), col = c("black", "black", NA, "red", "blue"), pt.bg = c(NA, NA, NA, "red",  "blue"), 
  bty = "n", pt.cex = 1.2, cex = 0.8)

# adding endotherms fit
x = seq(-10, 8, length = 100)
y = coef[1] + coef[4] + x * coef[2]
lines(x, y, lwd = 5, col = "white"); lines(x, y, lwd = 2, col = "red")

# adding ectotherm fit
x = seq(-12, 8, length = 100)
y = coef[1] + x * coef[2]
lines(x, y, lwd = 5, col = "white"); lines(x, y, lwd = 2, col = "blue")

mtext(side = 1, "Body weight", line = 3)

points((logRMR - T * coef[3]) ~ logM, data = rmr_data, 
  pch = c(NA, 24)[as.numeric(rmr_data$method)], cex = c(1, 1.3)[as.numeric(rmr_data$method)], 
  bg = pt.cols[rmr_data$therm], col = "white")

box()

# close the file to generate pdf
dev.off()
		
```